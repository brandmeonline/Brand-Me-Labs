# Copyright (c) Brand.Me, Inc. All rights reserved.
#
# Brand.Me v8 - Development Docker Compose
# ========================================
# Uses Spanner + Firestore emulators (PostgreSQL removed in v8)

version: '3.8'

services:
  # Google Cloud Spanner Emulator (v8 primary database)
  spanner-emulator:
    image: gcr.io/cloud-spanner-emulator/emulator:latest
    container_name: brandme-spanner-emulator
    ports:
      - "9010:9010"  # gRPC
      - "9020:9020"  # REST
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9020/v1/projects/test-project/instances"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  # Spanner Schema Initialization
  spanner-init:
    image: gcr.io/google.com/cloudsdktool/cloud-sdk:latest
    container_name: brandme-spanner-init
    depends_on:
      spanner-emulator:
        condition: service_healthy
    environment:
      SPANNER_EMULATOR_HOST: spanner-emulator:9010
    volumes:
      - ./brandme-data/spanner:/schemas
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        set -e
        gcloud config configurations create emulator 2>/dev/null || true
        gcloud config set auth/disable_credentials true
        gcloud config set project test-project
        gcloud config set api_endpoint_overrides/spanner http://spanner-emulator:9020/
        gcloud spanner instances create brandme-instance --config=emulator-config --description="BrandMe Dev Instance" --nodes=1 2>/dev/null || true
        gcloud spanner databases create brandme-db --instance=brandme-instance 2>/dev/null || true
        gcloud spanner databases ddl update brandme-db --instance=brandme-instance --ddl-file=/schemas/schema.sql || true
        echo "Spanner initialization complete!"

  # Google Cloud Firestore Emulator (real-time state)
  firestore-emulator:
    image: gcr.io/google.com/cloudsdktool/cloud-sdk:emulators
    container_name: brandme-firestore-emulator
    command: gcloud emulators firestore start --host-port=0.0.0.0:8080
    ports:
      - "8080:8080"
    environment:
      FIRESTORE_PROJECT_ID: brandme-dev
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 20s

  # NATS JetStream
  nats:
    image: nats:2.10-alpine
    container_name: brandme-nats
    command: ["-js", "-sd", "/data"]
    ports:
      - "4222:4222"  # Client
      - "8222:8222"  # HTTP monitoring
    volumes:
      - nats_data:/data
    healthcheck:
      test: ["CMD", "nats", "server", "check"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Gateway Service
  gateway:
    build:
      context: ./brandme-gateway
      dockerfile: Dockerfile
    container_name: brandme-gateway
    ports:
      - "3000:3000"
    environment:
      - PORT=3000
      - ENVIRONMENT=development
      - NATS_URL=nats://nats:4222
      - DEFAULT_REGION=us-east1
      - LOG_LEVEL=debug
      - OAUTH_CLIENT_ID=${OAUTH_CLIENT_ID:-dev-client-id}
      - OAUTH_CLIENT_SECRET=${OAUTH_CLIENT_SECRET:-dev-client-secret}
      - JWT_SECRET=${JWT_SECRET:-dev-jwt-secret-min-32-characters-long}
      - CORS_ORIGINS=http://localhost:3002
    depends_on:
      nats:
        condition: service_healthy
    volumes:
      - ./brandme-gateway/src:/app/src
    restart: unless-stopped

  # Core Services (AI Brain Hub, Policy & Safety, Orchestrator)
  # Uncomment when implemented
  # core:
  #   build:
  #     context: ./brandme-core
  #     dockerfile: Dockerfile
  #   container_name: brandme-core
  #   ports:
  #     - "8000:8000"
  #   environment:
  #     - SPANNER_EMULATOR_HOST=spanner-emulator:9010
  #     - SPANNER_PROJECT_ID=test-project
  #     - SPANNER_INSTANCE_ID=brandme-instance
  #     - SPANNER_DATABASE_ID=brandme-db
  #     - FIRESTORE_EMULATOR_HOST=firestore-emulator:8080
  #     - FIRESTORE_PROJECT_ID=brandme-dev
  #     - NATS_URL=nats://nats:4222
  #     - REGION_DEFAULT=us-east1
  #   depends_on:
  #     - spanner-init
  #     - firestore-emulator
  #     - nats
  #   volumes:
  #     - ./brandme-core/src:/app/src
  #   restart: unless-stopped

  # Agent Services (Identity, Knowledge, Compliance & Audit)
  # Uncomment when implemented
  # agents:
  #   build:
  #     context: ./brandme-agents
  #     dockerfile: Dockerfile
  #   container_name: brandme-agents
  #   ports:
  #     - "8001:8001"
  #   environment:
  #     - SPANNER_EMULATOR_HOST=spanner-emulator:9010
  #     - SPANNER_PROJECT_ID=test-project
  #     - SPANNER_INSTANCE_ID=brandme-instance
  #     - SPANNER_DATABASE_ID=brandme-db
  #     - NATS_URL=nats://nats:4222
  #   depends_on:
  #     - spanner-init
  #   volumes:
  #     - ./brandme-agents/src:/app/src
  #   restart: unless-stopped

  # Chain Service (Cardano + Midnight TX Builder)
  # Uncomment when implemented
  # chain:
  #   build:
  #     context: ./brandme-chain
  #     dockerfile: Dockerfile
  #   container_name: brandme-chain
  #   ports:
  #     - "3001:3001"
  #   environment:
  #     - PORT=3001
  #     - ENVIRONMENT=development
  #   volumes:
  #     - ./brandme-chain/src:/app/src
  #   restart: unless-stopped

  # Console (Next.js Frontend)
  # Uncomment when implemented
  # console:
  #   build:
  #     context: ./brandme-console
  #     dockerfile: Dockerfile
  #   container_name: brandme-console
  #   ports:
  #     - "3002:3002"
  #   environment:
  #     - NEXT_PUBLIC_GATEWAY_URL=http://localhost:3000
  #     - NEXT_PUBLIC_ENVIRONMENT=development
  #   volumes:
  #     - ./brandme-console:/app
  #     - /app/node_modules
  #     - /app/.next
  #   restart: unless-stopped

volumes:
  nats_data:
